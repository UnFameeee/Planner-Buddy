<%- include('partials/header') %>

<div class="container-fluid" id="contentContainer">
  <% if (typeof user !== 'undefined') { %>
    <!-- Logged in user view -->
    <div class="row">
      <div class="col-12">
        <div class="jumbotron py-5">
          <h1 class="display-5">Welcome, <%= user.username %>!</h1>
          <p class="lead">Manage your tasks and appointments with Planner Buddy.</p>
          <hr class="my-4">
        </div>
      </div>
    </div>
    
    <div class="row mb-4">
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0"><i class="fas fa-tasks"></i> Recent Todos</h5>
          </div>
          <div class="card-body" id="recentTodos">
            <div class="d-flex justify-content-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <a href="/todos/view/all" class="btn btn-sm btn-primary">View All Todos</a>
            <a href="/todos/view/create" class="btn btn-sm btn-outline-primary">Add New</a>
          </div>
        </div>
      </div>
      
      <div class="col-md-6 mb-4">
        <div class="card h-100">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0"><i class="far fa-calendar-alt"></i> Upcoming Appointments</h5>
          </div>
          <div class="card-body" id="upcomingAppointments">
            <div class="d-flex justify-content-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <a href="/appointments/view/calendar" class="btn btn-sm btn-primary">View Calendar</a>
            <a href="/appointments/view/create" class="btn btn-sm btn-outline-primary">Add New</a>
          </div>
        </div>
      </div>
    </div>
  <% } else { %>
    <!-- Public landing page -->
    <div class="row min-vh-100 align-items-center">
      <div class="col-lg-6 d-flex flex-column justify-content-center text-center text-lg-start p-5">
        <h1 class="display-4 fw-bold mb-4">Plan Your Day with Planner Buddy</h1>
        <p class="lead mb-4">A comprehensive task and appointment management system with email reminders via Gmail.</p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-start">
          <a href="/auth/register" class="btn btn-primary btn-lg px-4 me-md-2">Get Started</a>
          <a href="/auth/login" class="btn btn-outline-primary btn-lg px-4">Login</a>
        </div>
      </div>
      <div class="col-lg-6 d-none d-lg-block p-5">
        <img src="https://source.unsplash.com/random/800x600/?calendar,productivity" class="img-fluid rounded shadow-lg" alt="Planner Buddy">
      </div>
    </div>
  <% } %>
</div>

<!-- Authenticated user view template (hidden) -->
<div id="authenticatedUserTemplate" style="display: none;">
  <div class="row">
    <div class="col-12">
      <div class="jumbotron py-5">
        <h1 class="display-5">Welcome, <span id="username"></span>!</h1>
        <p class="lead">Manage your tasks and appointments with Planner Buddy.</p>
        <hr class="my-4">
      </div>
    </div>
  </div>
  
  <div class="row mb-4">
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0"><i class="fas fa-tasks"></i> Recent Todos</h5>
        </div>
        <div class="card-body" id="recentTodosAuth">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="/todos/view/all" class="btn btn-sm btn-primary">View All Todos</a>
          <a href="/todos/view/create" class="btn btn-sm btn-outline-primary">Add New</a>
        </div>
      </div>
    </div>
    
    <div class="col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0"><i class="far fa-calendar-alt"></i> Upcoming Appointments</h5>
        </div>
        <div class="card-body" id="upcomingAppointmentsAuth">
          <div class="d-flex justify-content-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="/appointments/view/calendar" class="btn btn-sm btn-primary">View Calendar</a>
          <a href="/appointments/view/create" class="btn btn-sm btn-outline-primary">Add New</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check for token in localStorage
    const token = localStorage.getItem('token');
    
    if (token) {
      try {
        // Decode token and check expiration
        const payload = JSON.parse(atob(token.split('.')[1]));
        const exp = payload.exp * 1000; // Convert to milliseconds
        
        if (Date.now() < exp) {
          // Token is valid, update UI for authenticated user
          document.getElementById('username').textContent = payload.username;
          
          // Replace content with authenticated user view
          document.getElementById('contentContainer').innerHTML = document.getElementById('authenticatedUserTemplate').innerHTML;
          document.getElementById('authenticatedUserTemplate').remove();
          
          // Load data for authenticated user
          loadAuthenticatedUserData(token);
        } else {
          // Token expired, remove it
          localStorage.removeItem('token');
        }
      } catch (e) {
        console.error('Error parsing token:', e);
        localStorage.removeItem('token');
      }
    }
  });
  
  function loadAuthenticatedUserData(token) {
    // Fetch recent todos
    fetch('/todos?limit=5&sortBy=due_date&sortOrder=ASC', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => response.json())
    .then(data => {
      const todosContainer = document.getElementById('recentTodosAuth');
      
      if (data.success && data.data.todos && data.data.todos.length > 0) {
        let html = '<ul class="list-group list-group-flush">';
        
        data.data.todos.forEach(todo => {
          const dueDate = todo.due_date ? new Date(todo.due_date).toLocaleDateString() : 'No due date';
          const priorityClass = todo.priority === 'high' ? 'text-danger' : 
                               todo.priority === 'medium' ? 'text-warning' : 'text-success';
          
          html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">${todo.title}</h6>
                <small class="text-muted">Due: ${dueDate}</small>
              </div>
              <span class="badge rounded-pill ${priorityClass}">${todo.priority}</span>
            </li>
          `;
        });
        
        html += '</ul>';
        todosContainer.innerHTML = html;
      } else {
        todosContainer.innerHTML = '<p class="text-center">No todos found. Create one!</p>';
      }
    })
    .catch(error => {
      console.error('Error fetching todos:', error);
      document.getElementById('recentTodosAuth').innerHTML = '<p class="text-danger">Error loading todos</p>';
    });
    
    // Fetch upcoming appointments
    fetch('/appointments?limit=5&sortBy=start_time&sortOrder=ASC', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(response => response.json())
    .then(data => {
      const appointmentsContainer = document.getElementById('upcomingAppointmentsAuth');
      
      if (data.success && data.data.appointments && data.data.appointments.length > 0) {
        let html = '<ul class="list-group list-group-flush">';
        
        data.data.appointments.forEach(appointment => {
          const startTime = new Date(appointment.start_time).toLocaleString();
          
          html += `
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-0">${appointment.title}</h6>
                <small class="text-muted">${startTime}</small>
              </div>
              <small class="text-muted">${appointment.location || 'No location'}</small>
            </li>
          `;
        });
        
        html += '</ul>';
        appointmentsContainer.innerHTML = html;
      } else {
        appointmentsContainer.innerHTML = '<p class="text-center">No appointments found. Create one!</p>';
      }
    })
    .catch(error => {
      console.error('Error fetching appointments:', error);
      document.getElementById('upcomingAppointmentsAuth').innerHTML = '<p class="text-danger">Error loading appointments</p>';
    });
  }
</script>

<% if (typeof user !== 'undefined') { %>
  <!-- Scripts for loading dashboard data -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        window.location.href = '/auth/login';
        return;
      }
      
      // Fetch recent todos
      fetch('/todos?limit=5&sortBy=due_date&sortOrder=ASC', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        const todosContainer = document.getElementById('recentTodos');
        
        if (data.success && data.data.todos && data.data.todos.length > 0) {
          let html = '<ul class="list-group list-group-flush">';
          
          data.data.todos.forEach(todo => {
            const dueDate = todo.due_date ? new Date(todo.due_date).toLocaleDateString() : 'No due date';
            const priorityClass = todo.priority === 'high' ? 'text-danger' : 
                                 todo.priority === 'medium' ? 'text-warning' : 'text-success';
            
            html += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">${todo.title}</h6>
                  <small class="text-muted">Due: ${dueDate}</small>
                </div>
                <span class="badge rounded-pill ${priorityClass}">${todo.priority}</span>
              </li>
            `;
          });
          
          html += '</ul>';
          todosContainer.innerHTML = html;
        } else {
          todosContainer.innerHTML = '<p class="text-center">No todos found. Create one!</p>';
        }
      })
      .catch(error => {
        console.error('Error fetching todos:', error);
        document.getElementById('recentTodos').innerHTML = '<p class="text-danger">Error loading todos</p>';
      });
      
      // Fetch upcoming appointments
      fetch('/appointments?limit=5&sortBy=start_time&sortOrder=ASC', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => response.json())
      .then(data => {
        const appointmentsContainer = document.getElementById('upcomingAppointments');
        
        if (data.success && data.data.appointments && data.data.appointments.length > 0) {
          let html = '<ul class="list-group list-group-flush">';
          
          data.data.appointments.forEach(appointment => {
            const startTime = new Date(appointment.start_time).toLocaleString();
            
            html += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-0">${appointment.title}</h6>
                  <small class="text-muted">${startTime}</small>
                </div>
                <small class="text-muted">${appointment.location || 'No location'}</small>
              </li>
            `;
          });
          
          html += '</ul>';
          appointmentsContainer.innerHTML = html;
        } else {
          appointmentsContainer.innerHTML = '<p class="text-center">No appointments found. Create one!</p>';
        }
      })
      .catch(error => {
        console.error('Error fetching appointments:', error);
        document.getElementById('upcomingAppointments').innerHTML = '<p class="text-danger">Error loading appointments</p>';
      });
    });
  </script>
<% } %>

<%- include('partials/footer') %> 